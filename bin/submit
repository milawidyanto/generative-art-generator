#!/bin/bash

if [[ $# -ne 1 && $# -ne 2 ]]; then
    echo -e "Usage: $0 <crunch_date> [<workflow_dir>]"
    exit 1
fi

set -e

USER=$(get-properties -k user)
PROJECT=$(get-conf -k project)
PROJECT_ENTRYPOINT=$(get-conf -k project_entrypoint)
TMP_DIR=/tmp/scaffolding/$$
TMP_PROPERTIES_FILE=$TMP_DIR/job.properties
TMP_OOZIE_JOB_FILE=$TMP_DIR/oozie.out
CRUNCH_DATE=$1
WORKFLOW_DIR=${2-$PROJECT_ENTRYPOINT}

mkdir -p $TMP_DIR
get-properties > $TMP_PROPERTIES_FILE
oozie job -oozie http://mgmt0.hadoop.trivago.com:11000/oozie \
    -config $TMP_PROPERTIES_FILE \
    -D crunchDate=$CRUNCH_DATE \
    -D oozie.wf.application.path=hdfs://nameservice1/user/$USER/$PROJECT/build/$WORKFLOW_DIR \
    -run > $TMP_OOZIE_JOB_FILE

if [[ $(cat $TMP_OOZIE_JOB_FILE) =~ ^job:\ (.*)$ ]]; then
    echo "Job sumitted, you can monitor it here:"
    echo "http://mgmt1.hadoop.trivago.com:8889/oozie/list_oozie_workflow/${BASH_REMATCH[1]}"
else
    echo "Oozie is doing something weird!!!"
    cat $TMP_OOZIE_JOB_FILE
fi
