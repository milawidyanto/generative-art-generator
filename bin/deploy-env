#!/bin/bash

set -e

PROJECT=$(get-conf -k project)
REQUIREMENTS_FILE=$(get-conf -k requirements_file)
BUILD_DIR=/tmp/scaffolding/$$/build

echo "Cleaning previous build..."
rm -f -r $BUILD_DIR

echo "Creating Conda environment... ($BUILD_DIR/env)"
/opt/miniconda/bin/conda create --file $REQUIREMENTS_FILE --copy -y -p $BUILD_DIR/env

echo "Creating compressed environmet file ($BUILD_DIR/env.zip)"
(cd $BUILD_DIR/env/ && zip -r $BUILD_DIR/env.zip *)

echo "Copying environment to HDFS..."
hdfs dfs -mkdir -p $PROJECT/
hdfs dfs -copyFromLocal -f $BUILD_DIR/env.zip $PROJECT/env.zip
